package org.firstinspires.ftc.teamcode.Meet3;

import com.qualcomm.robotcore.eventloop.opmode.OpMode;
import com.qualcomm.robotcore.eventloop.opmode.TeleOp;
import com.qualcomm.robotcore.hardware.DcMotor;
import com.qualcomm.robotcore.hardware.DcMotorEx;
import com.qualcomm.robotcore.hardware.DcMotorSimple;
import com.qualcomm.robotcore.hardware.PIDFCoefficients;
import com.qualcomm.robotcore.hardware.ServoImplEx;
import com.qualcomm.robotcore.hardware.PwmControl;
import com.pedropathing.follower.Follower;
import com.pedropathing.geometry.Pose;
import org.firstinspires.ftc.teamcode.pedroPathing.Constants;

@TeleOp(name="FlywheelHoodTunerWithDistance", group="Tuning")
public class FlywheelHoodTunerWithDistance extends OpMode {

    // Drive motors
    private DcMotor rightBack;
    private DcMotor rightFront;
    private DcMotor leftFront;
    private DcMotor leftBack;

    // Flywheel motors
    private DcMotorEx Shooter;
    private DcMotorEx Shooter2;

    private DcMotor Intake;
    private DcMotor Control;

    // Hood servo (Axon servo)
    private ServoImplEx Hood;

    // Pedro Pathing
    private Follower follower;
    private Pose curPose;
    private final Pose startPose = new Pose(51, 91, Math.toRadians(143));

    // Goal position coordinates (13, 135)
    private static final double GOAL_X = 13.0;
    private static final double GOAL_Y = 135.0;

    // Tuning variables
    private int increment = 1;  // Current increment value (1, 5, or 10)
    private double flywheelVelocity = 1130;  // Starting velocity
    private double hoodPosition = 0;  // Starting hood position (0.0 to 1.0)

    // Button debouncing
    private boolean aPressed = false;
    private boolean dpadUpPressed = false;
    private boolean dpadDownPressed = false;
    private boolean dpadRightPressed = false;
    private boolean dpadLeftPressed = false;

    @Override
    public void init() {
        // Initialize Pedro Pathing
        follower = Constants.createFollower(hardwareMap);
        follower.setPose(startPose);

        // Initialize drive motors
        rightBack = hardwareMap.get(DcMotor.class, "rightBack");
        rightFront = hardwareMap.get(DcMotor.class, "rightFront");
        leftFront = hardwareMap.get(DcMotor.class, "leftFront");
        leftBack = hardwareMap.get(DcMotor.class, "leftBack");

        // Set drive motor directions
        rightBack.setDirection(DcMotor.Direction.FORWARD);
        rightFront.setDirection(DcMotor.Direction.FORWARD);
        leftFront.setDirection(DcMotor.Direction.REVERSE);
        leftBack.setDirection(DcMotor.Direction.REVERSE);

        // Initialize flywheel motors
        Shooter = hardwareMap.get(DcMotorEx.class, "Shooter");
        Shooter2 = hardwareMap.get(DcMotorEx.class, "Shooter2");
        Intake = hardwareMap.get(DcMotor.class, "Intake");
        Control = hardwareMap.get(DcMotor.class, "Control");

        // Initialize hood servo (Axon servo)
        Hood = hardwareMap.get(ServoImplEx.class, "Hood");

        // Configure Axon servo for extended PWM range (500-2500 microseconds for 270Â° rotation)
        Hood.setPwmRange(new PwmControl.PwmRange(500, 2500));

        // Set motor directions
        Shooter.setDirection(DcMotorSimple.Direction.REVERSE);
        Shooter2.setDirection(DcMotorSimple.Direction.FORWARD);
        Control.setDirection(DcMotorSimple.Direction.REVERSE);

        // Set motor modes
        Shooter.setMode(DcMotor.RunMode.RUN_USING_ENCODER);
        Shooter2.setMode(DcMotor.RunMode.RUN_USING_ENCODER);

        // Configure PIDF coefficients
        PIDFCoefficients SHOOTERpidfCoefficients = new PIDFCoefficients(0.002, 0, 0, 15.5);
        Shooter.setPIDFCoefficients(DcMotor.RunMode.RUN_USING_ENCODER, SHOOTERpidfCoefficients);
        Shooter2.setPIDFCoefficients(DcMotor.RunMode.RUN_USING_ENCODER, SHOOTERpidfCoefficients);

        // Set initial hood position
        Hood.setPosition(hoodPosition);

        telemetry.addData("Status", "Initialized");
        telemetry.addData("Goal Position", "X: %.1f, Y: %.1f", GOAL_X, GOAL_Y);
        telemetry.addData("Controls", "A: Cycle Increment | DPad Up/Down: Velocity | DPad Right/Left: Hood");
    }

    @Override
    public void loop() {
        // Update Pedro Pathing localization
        follower.update();
        curPose = follower.getPose();

        // Get current robot coordinates
        double robotX = curPose.getX();
        double robotY = curPose.getY();

        // Calculate distance to goal using distance formula: sqrt((x2-x1)^2 + (y2-y1)^2)
        double deltaX = GOAL_X - robotX;
        double deltaY = GOAL_Y - robotY;
        double distanceToGoal = Math.sqrt(deltaX * deltaX + deltaY * deltaY);

        // DRIVE CONTROLS - Left stick for movement, right stick for turning
        double drive = -gamepad1.left_stick_y;  // Forward/backward
        double strafe = gamepad1.left_stick_x;   // Left/right strafing
        double turn = gamepad1.right_stick_x * 0.8;    // Turning (reduced to 80% speed)

        // Calculate mecanum drive powers
        double leftFrontPower = drive + strafe + turn;
        double rightFrontPower = drive - strafe - turn;
        double leftBackPower = drive - strafe + turn;
        double rightBackPower = drive + strafe - turn;

        // Normalize powers if any exceed 1.0
        double maxPower = Math.max(Math.abs(leftFrontPower),
                Math.max(Math.abs(rightFrontPower),
                        Math.max(Math.abs(leftBackPower),
                                Math.abs(rightBackPower))));

        if (maxPower > 1.0) {
            leftFrontPower /= maxPower;
            rightFrontPower /= maxPower;
            leftBackPower /= maxPower;
            rightBackPower /= maxPower;
        }

        // Set drive motor powers
        leftFront.setPower(leftFrontPower);
        rightFront.setPower(rightFrontPower);
        leftBack.setPower(leftBackPower);
        rightBack.setPower(rightBackPower);

        // Run Control motor and Intake
        Control.setPower(0.3);
        Intake.setPower(1);

        // A button - Cycle through increment values (1 -> 5 -> 10 -> 1)
        if (gamepad1.a && !aPressed) {
            aPressed = true;
            if (increment == 1) {
                increment = 5;
            } else if (increment == 5) {
                increment = 10;
            } else {
                increment = 1;
            }
        } else if (!gamepad1.a) {
            aPressed = false;
        }

        // DPad Up - Increase flywheel velocity by current increment
        if (gamepad1.dpad_up && !dpadUpPressed) {
            dpadUpPressed = true;
            flywheelVelocity += increment;
        } else if (!gamepad1.dpad_up) {
            dpadUpPressed = false;
        }

        // DPad Down - Decrease flywheel velocity by current increment
        if (gamepad1.dpad_down && !dpadDownPressed) {
            dpadDownPressed = true;
            flywheelVelocity -= increment;
            // Prevent negative velocity
            if (flywheelVelocity < 0) {
                flywheelVelocity = 0;
            }
        } else if (!gamepad1.dpad_down) {
            dpadDownPressed = false;
        }

        // DPad Right - Increase hood position by increment (converted to servo scale)
        if (gamepad1.dpad_right && !dpadRightPressed) {
            dpadRightPressed = true;
            // Convert increment to servo scale (assuming 1 tick = 0.001 position)
            hoodPosition += increment * 0.001;
            // Clamp to servo range
            if (hoodPosition > 1.0) {
                hoodPosition = 1.0;
            }
        } else if (!gamepad1.dpad_right) {
            dpadRightPressed = false;
        }

        // DPad Left - Decrease hood position by increment
        if (gamepad1.dpad_left && !dpadLeftPressed) {
            dpadLeftPressed = true;
            hoodPosition -= increment * 0.001;
            // Clamp to servo range
            if (hoodPosition < 0.0) {
                hoodPosition = 0.0;
            }
        } else if (!gamepad1.dpad_left) {
            dpadLeftPressed = false;
        }

        // Apply settings to motors and servo
        Shooter.setVelocity(flywheelVelocity);
        Shooter2.setVelocity(flywheelVelocity);
        Hood.setPosition(hoodPosition);

        // Telemetry
        telemetry.addData("=== POSITION DATA ===", "");
        telemetry.addData("Robot Position", "X: %.1f, Y: %.1f", robotX, robotY);
        telemetry.addData("Distance to Goal", "%.2f inches", distanceToGoal);
        telemetry.addData("", "");
        telemetry.addData("=== TUNING VALUES ===", "");
        telemetry.addData("Current Increment", increment);
        telemetry.addData("Flywheel Velocity", "%.0f", flywheelVelocity);
        telemetry.addData("Hood Position", "%.3f (%.0f ticks)", hoodPosition, hoodPosition * 1000);
        telemetry.addData("", "");
        telemetry.addData("=== CONTROLS ===", "");
        telemetry.addData("Left Stick", "Drive");
        telemetry.addData("Right Stick", "Turn");
        telemetry.addData("A Button", "Cycle Increment (1/5/10)");
        telemetry.addData("DPad Up/Down", "Adjust Velocity");
        telemetry.addData("DPad Right/Left", "Adjust Hood");
        telemetry.update();
    }
}
